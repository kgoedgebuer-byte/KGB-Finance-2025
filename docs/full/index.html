<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KGB Finance 2025 ‚Äî Web (Full)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#7c9cf5">
  <link rel="icon" href="icons/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="app.js"></script>
  <link <link rel="apple-touch-icon" sizes="180x180" href="../icons/kgb-full-180.png">
  <link rel="stylesheet" href="../common/sync_embed.css">
  <link rel="stylesheet" href="../common/ui_fix.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
<header class="bar">
  <h1>üí∞ KGB Finance 2025 ‚Äî Web (Full)</h1>
  <nav class="tabs">
    <button data-tab="dashboard" class="tab active">Dashboard</button>
    <button data-tab="budget" class="tab">Budget</button>
    <button data-tab="invest" class="tab">Beleggingen</button>
    <button data-tab="crypto" class="tab">Crypto</button>
    <button data-tab="agenda" class="tab">Agenda</button>
    <button data-tab="family" class="tab">Familie</button>
    <button data-tab="theme" class="tab">Thema</button>
    <button data-tab="io" class="tab">Export / Import</button>
  </nav>
</header>

<main>
  <section id="dashboard" class="panel active">
    <div class="cards">
      <div class="card"><div class="k">Inkomen</div><div class="v" id="totIncome">0,00</div></div>
      <div class="card"><div class="k">Uitgave</div><div class="v" id="totExpense">0,00</div></div>
      <div class="card"><div class="k">Saldo</div><div class="v ok" id="totSaldo">0,00</div></div>
      <div class="card"><div class="k">Beleggingen (netto)</div><div class="v" id="totInvest">0,00</div></div>
      <div class="card"><div class="k">Crypto (netto)</div><div class="v" id="totCrypto">0,00</div></div>
    </div>
    <div class="chartBar">
      <div class="left">
        <strong>Grafiek:</strong>
        <label><input type="radio" name="ctype" value="line" checked> Lijn</label>
        <label><input type="radio" name="ctype" value="bar"> Balk</label>
        <label><input type="radio" name="ctype" value="pie"> Cirkel</label>
      </div>
      <div class="right">
        <button id="btnDemo">Demo-data</button>
        <button id="btnClear">Alles wissen</button>
      </div>
    </div>
    <canvas id="saldoChart" height="160"></canvas>
  </section>

  <section id="budget" class="panel">
    <h2>üìã Budget</h2>
    <form id="addBudget" class="addForm">
      <input id="b_date" type="date" required />
      <input id="b_cat" type="text" placeholder="Categorie" required />
      <input id="b_desc" type="text" placeholder="Omschrijving" />
      <input id="b_inc" type="number" step="0.01" inputmode="decimal" placeholder="Inkomen">
      <input id="b_exp" type="number" step="0.01" inputmode="decimal" placeholder="Uitgave">
      <button type="submit">‚ûï Toevoegen</button>
    </form>
    <div class="tableWrap">
      <table id="tblBudget" class="grid">
        <thead><tr><th>Datum</th><th>Categorie</th><th>Omschrijving</th><th>Inkomen</th><th>Uitgave</th><th>Saldo</th><th>Acties</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="invest" class="panel">
    <h2>üíº Beleggingen</h2>
    <form id="addInvest" class="addForm">
      <input id="i_date" type="date" required />
      <input id="i_name" type="text" placeholder="Aandeel" required />
      <input id="i_qty" type="number" step="0.0001" inputmode="decimal" placeholder="Aantal" required />
      <input id="i_buy" type="number" step="0.01" inputmode="decimal" placeholder="Aankoop">
      <input id="i_sell" type="number" step="0.01" inputmode="decimal" placeholder="Verkoop">
      <input id="i_div" type="number" step="0.01" inputmode="decimal" placeholder="Dividend">
      <button type="submit">‚ûï Toevoegen</button>
    </form>
    <div class="tableWrap">
      <table id="tblInvest" class="grid">
        <thead><tr><th>Datum</th><th>Aandeel</th><th>Aantal</th><th>Aankoop</th><th>Verkoop</th><th>Dividend</th><th>Winst</th><th>Verlies</th><th>Acties</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="crypto" class="panel">
    <h2>ü™ô Crypto</h2>
    <form id="addCrypto" class="addForm">
      <input id="c_date" type="date" required />
      <input id="c_token" type="text" placeholder="Token" required />
      <input id="c_qty" type="number" step="0.0001" inputmode="decimal" placeholder="Aantal" required />
      <input id="c_buy" type="number" step="0.01" inputmode="decimal" placeholder="Aankoop">
      <input id="c_sell" type="number" step="0.01" inputmode="decimal" placeholder="Verkoop">
      <button type="submit">‚ûï Toevoegen</button>
    </form>
    <div class="tableWrap">
      <table id="tblCrypto" class="grid">
        <thead><tr><th>Datum</th><th>Token</th><th>Aantal</th><th>Aankoop</th><th>Verkoop</th><th>Winst</th><th>Verlies</th><th>Acties</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="agenda" class="panel">
    <h2>üóìÔ∏è Agenda</h2>
    <form id="addAgenda" class="addForm">
      <input id="a_date" type="date" required />
      <input id="a_task" type="text" placeholder="Taak" required />
      <input id="a_status" type="text" placeholder="Status" />
      <input id="a_meet" type="text" placeholder="Afspraak" />
      <button type="submit">‚ûï Toevoegen</button>
    </form>
    <div class="tableWrap">
      <table id="tblAgenda" class="grid">
        <thead><tr><th>Datum</th><th>Taak</th><th>Status</th><th>Afspraak</th><th>Acties</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="family" class="panel">
    <h2>üë®‚Äçüë©‚Äçüëß Familie</h2>
    <p class="muted">Deel deze link met familie. Data blijft per toestel. Delen? Gebruik Export/Import JSON.</p>
  </section>

  <section id="theme" class="panel">
    <h2>üé® Thema</h2>
    <div class="themeBox">
      <label>Onderdeel:
        <select id="themeTarget">
          <option value="bg">Achtergrond</option>
          <option value="card">Kaarten/Tabel</option>
          <option value="acc">Accent/Knoppen</option>
          <option value="grid">Rasterlijnen</option>
          <option value="txt">Tekst</option>
        </select>
      </label>
      <div id="swatches" class="swatches"></div>
      <div class="sliders">
        <label>Intensiteit <input id="intensity" type="range" min="50" max="150" value="100"></label>
        <label>Raster <input id="gridIntensity" type="range" min="50" max="150" value="100"></label>
      </div>
      <div class="themeBtns">
        <button id="themeReset">Reset</button>
        <button id="themeSave">Opslaan</button>
      </div>
    </div>
  </section>

  <section id="io" class="panel">
    <h2>‚¨áÔ∏è Export / ‚¨ÜÔ∏è Import</h2>
    <div class="io-actions">
      <button id="btnExport">Export JSON</button>
      <label class="fileLabel">Import JSON <input id="fileImport" type="file" accept="application/json"></label>
      <button id="btnReset" class="danger">Reset (alles wissen)</button>
    </div>
    <p class="muted">PWA ‚Äì werkt offline na 1√ó laden.</p>
  </section>
</main>

<footer><small>¬© KGB Finance 2025</small></footer>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => void 0 && navigator.serviceWorker.register('./service-worker.js'));
}
</script>
<script>if('serviceWorker' in navigator){void 0 && navigator.serviceWorker.register('./sw.js',{scope:'./'});}</script>
  <script src="../common/sync_embed.js" defer></script>
  <script src="../common/kgb_year_dropdown.js" defer></script>
  <script src="../common/drive_autopull.js"></script>
  <script src="../common/ui_fix.js"></script>
  <script defer src="../common/pwa_hotfix.js"></script>
  <script defer src="../common/layout_fix.js"></script>
  <script defer src="../common/ui_rescue.js"></script>

<style id="kgb-fix-style">
  /* Scroll altijd toestaan (sommige apps zetten body op hidden) */
  html, body { overflow: auto !important; }
  /* Zet jaar-UI nooit fullscreen/fixed */
  .year-fixed, .year-floating, #year-box, [data-year], .year, .kgb-year {
    position: static !important; inset:auto !important; width:auto !important; height:auto !important;
    pointer-events:auto !important; z-index:auto !important; display:inline-block !important; margin:0 .5rem .5rem 0 !important;
  }
  /* Maak mogelijke overlays onschadelijk */
  .kgb-blocker, [role="dialog"], [aria-modal="true"], .modal, .overlay, .backdrop, .scrim {
    pointer-events:none !important; background:transparent !important;
  }
</style>
<script id="kgb-fix-clicks">
(function(){
  // 1) Service Workers neutraliseren (klik-blok via SW/FS overlays voorkomen)
  if ('serviceWorker' in navigator) {
    try {
      navigator.serviceWorker.getRegistrations()
        .then(rs => Promise.all(rs.map(r => r.unregister())))
        .catch(()=>{});
      // Blokkeer toekomstige registraties
      try {
        var _orig = navigator.serviceWorker.register;
        navigator.serviceWorker.register = function(){
          console.log('KGB: SW-register geblokkeerd');
          return Promise.resolve({unregister:()=>Promise.resolve(true)});
        };
      } catch(e){}
    } catch(e){}
  }
  // Ruim caches op die mogelijk overlay-assets vasthouden
  try {
    if (window.caches && caches.keys) {
      caches.keys().then(ks => Promise.all(ks.map(k => caches.delete(k)))).catch(()=>{});
    }
  } catch(e){}

  // 2) Heuristiek: identificeer een fullscreen overlay rond centrum en ontkoppel clicks
  function killBlocker(){
    try{
      const vw = window.innerWidth, vh = window.innerHeight;
      const stack = (document.elementsFromPoint?.(vw/2, vh/2)) || [];
      let best = null, bestZi = -1;
      for (const el of stack){
        const cs = getComputedStyle(el);
        if (!cs) continue;
        const r = el.getBoundingClientRect?.(); if (!r) continue;
        const zi = parseInt(cs.zIndex||"0")||0;
        if ((cs.position==='fixed' || cs.position==='absolute')
            && r.width > vw*0.6 && r.height > vh*0.6
            && zi >= 10 && el !== document.documentElement && el !== document.body){
          if (zi > bestZi) { best = el; bestZi = zi; }
        }
      }
      if (best){
        best.classList.add('kgb-blocker');
        console.log('KGB: click-blocker uitgeschakeld:', best.tagName, 'z=', bestZi);
      }
    }catch(e){ console.log('KGB fix fout:', e); }
  }

  // 3) Re-try vensters (load, visibility, DOM-mutaties)
  function schedule(){
    setTimeout(killBlocker, 100);
    setTimeout(killBlocker, 600);
    setTimeout(killBlocker, 1500);
    let n = 0; const t = setInterval(()=>{ killBlocker(); if (++n>6) clearInterval(t); }, 500);
  }
  window.addEventListener('load', schedule, { once: true });
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) schedule(); });

  try{
    const mo = new MutationObserver(()=> killBlocker());
    mo.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true});
  }catch(e){}
})();
</script>


<style id="kgb-fix-style-v2">
  html, body { overflow:auto !important; }
  html, body, #root, #app, main, .app { pointer-events:auto !important; }
  /* Enable echte UI */
  a, button, input, select, textarea, summary,
  [role="button"], [role="link"], [role="tab"],
  [onclick], [tabindex], .btn, .button, .tab, .nav, canvas {
    pointer-events:auto !important;
    touch-action:auto !important;
  }
  /* Typische blockers */
  .kgb-blocker, .overlay, .backdrop, .modal, [aria-modal="true"] {
    pointer-events:none !important; background:transparent !important;
  }
  * { -webkit-user-select:text !important; user-select:text !important; }
</style>
<script id="kgb-fix-clicks-v2">
(function(){
  if (window.__kgb_fix_v2) return; window.__kgb_fix_v2 = true;

  // SW uitschakelen + caches leeg
  if ('serviceWorker' in navigator) {
    try { navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())); } catch(e){}
    try {
      const orig = navigator.serviceWorker.register;
      navigator.serviceWorker.register = function(){ console.log('KGB v2: SW-register geblokkeerd'); return Promise.resolve({unregister:()=>Promise.resolve(true)}); };
    } catch(e){}
  }
  try { if (window.caches && caches.keys) caches.keys().then(ks => Promise.all(ks.map(k => caches.delete(k)))); } catch(e){}

  // Dialogs dicht + aria modalities weg
  function closeDialogs(){
    try{
      document.querySelectorAll('dialog[open]').forEach(d=>{ try{ d.open && d.close(); }catch(e){} });
      document.querySelectorAll('[aria-modal="true"]').forEach(el=>{ el.removeAttribute('aria-modal'); });
    }catch(e){}
  }

  // Heuristiek om overlays te neutraliseren (incl. iframes)
  function detectOverlays(){
    const vw = Math.max(1, window.innerWidth || 1);
    const vh = Math.max(1, window.innerHeight || 1);
    const pts = [
      [vw/2, vh/2],[5,5],[vw-5,5],[5,vh-5],[vw-5,vh-5],
      [vw/2,5],[vw/2,vh-5],[5,vh/2],[vw-5,vh/2]
    ];
    const seen = new Set(); const cands = [];
    for (const [x,y] of pts){
      const stack = document.elementsFromPoint ? document.elementsFromPoint(x,y) : [];
      for (const el of stack){
        if (!el || seen.has(el)) continue; seen.add(el);
        try{
          const cs = getComputedStyle(el);
          if (!cs) continue;
          const r = el.getBoundingClientRect?.(); if (!r) continue;
          const zi = parseInt(cs.zIndex||"0")||0;
          const fixedish = cs.position === 'fixed' || cs.position === 'absolute' || cs.position === 'sticky';
          const area = Math.max(0, r.width) * Math.max(0, r.height);
          const ratio = area / (vw*vh);
          if (
            fixedish &&
            (ratio > 0.40 || (r.top<=1 && r.left<=1 && r.width>=vw*0.95 && r.height>=vh*0.80)) &&
            zi >= 10 &&
            el !== document.documentElement && el !== document.body
          ){
            cands.push([el, zi, ratio]);
          }
        }catch(e){}
      }
    }
    // Pak ook de grootste fixed/absolute in het document
    try{
      let best = null, bestScore = 0;
      const all = document.querySelectorAll('body *');
      const limit = Math.min(all.length, 4000); // safeguard
      for (let i=0;i<limit;i++){
        const el = all[i]; if (!el) break;
        const cs = getComputedStyle(el); if (!cs) continue;
        if (!(cs.position==='fixed' || cs.position==='absolute')) continue;
        const r = el.getBoundingClientRect?.(); if (!r) continue;
        const zi = parseInt(cs.zIndex||"0")||0;
        const area = Math.max(0, r.width) * Math.max(0, r.height);
        const score = area * (zi+1);
        if (score > bestScore) { best = el; bestScore = score; }
      }
      if (best) cands.push([best, parseInt(getComputedStyle(best).zIndex||"0")||0, 1]);
    }catch(e){}

    // Normaliseer kandidaten en filter nested dupes
    const uniq = [];
    for (const [el,zi,ra] of cands){
      if (!uniq.some(([e])=> e===el)) uniq.push([el,zi,ra]);
    }

    // Neutraliseer
    for (const [el, zi, ra] of uniq){
      try{
        if (el.tagName === 'IFRAME'){
          el.dataset.kgbBlocked = '1';
          el.style.pointerEvents = 'none'; // waarom: iframe onderschept altijd
          el.style.visibility = 'hidden';
          console.log('KGB v2: iframe overlay geneutraliseerd', zi, ra.toFixed(2));
          continue;
        }
        el.classList.add('kgb-blocker');
        // display:contents behoudt layout maar verwijdert box voor pointer-events
        try { el.style.display = 'contents'; } catch(_){}
        el.style.pointerEvents = 'none';
        el.style.background = 'transparent';
        el.style.backdropFilter = 'none';
        el.style.filter = 'none';
        el.removeAttribute('inert');
        console.log('KGB v2: overlay uitgeschakeld', el.tagName, 'z=', zi, 'ratio=', ra.toFixed(2));
      }catch(e){}
    }
  }

  // Herstel interactie op UI-elementen
  function ensureInteractive(){
    try{
      const sel = 'a,button,input,select,textarea,summary,[role="button"],[role="link"],[role="tab"],[onclick],[tabindex],canvas';
      document.querySelectorAll(sel).forEach(el=>{
        const cs = getComputedStyle(el);
        if (cs.pointerEvents === 'none') el.style.pointerEvents = 'auto';
      });
    }catch(e){}
  }

  function runAll(){
    closeDialogs();
    detectOverlays();
    ensureInteractive();
  }

  // Schedules
  const schedule = () => {
    runAll();
    setTimeout(runAll, 120);
    setTimeout(runAll, 500);
    setTimeout(runAll, 1500);
    let n=0; const t=setInterval(()=>{ runAll(); if(++n>6) clearInterval(t); }, 600);
  };

  window.addEventListener('load', schedule, {once:true});
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) schedule(); });
  window.addEventListener('resize', ()=> schedule(), {passive:true});

  try{
    const mo = new MutationObserver(()=> runAll());
    mo.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true});
  }catch(e){}

  // Esc om opnieuw te proberen
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') schedule(); }, {passive:true});
})();
</script>


<style id="kgb-fix-style-v3">
  html, body, #root, #app, main { pointer-events:auto !important; overflow:auto !important; }
  a,button,input,select,textarea,summary,[role="button"],[role="link"],[role="tab"],[onclick],[tabindex],canvas {
    pointer-events:auto !important; touch-action:auto !important;
  }
  .kgb-overlay, .overlay, .backdrop, .modal, .scrim, [aria-modal="true"] {
    pointer-events:none !important; background:transparent !important; backdrop-filter:none !important; filter:none !important;
  }
  * { -webkit-user-select:text !important; user-select:text !important; }
</style>
<script id="kgb-fix-clicks-v3">
(function(){
  if (window.__kgb_fix_v3) return; window.__kgb_fix_v3 = true;

  // ‚Äî‚Äî‚Äî 0) Herstel echte SW.register (v2 kon het stubbben)
  try {
    if ('serviceWorker' in navigator) {
      const sw = navigator.serviceWorker;
      const proto = Object.getPrototypeOf(sw);
      if (proto && proto.register && sw.register !== proto.register) {
        sw.register = proto.register.bind(sw); // waarom: app kan wachten op echte Promise van register
        console.log('KGB v3: SW.register hersteld');
      }
    }
  } catch (e) {}

  // ‚Äî‚Äî‚Äî 1) Unfreeze UI: inert weg + dialogs dicht
  function unfreeze(){
    try {
      document.querySelectorAll('[inert]').forEach(el=>el.removeAttribute('inert'));
      document.querySelectorAll('dialog[open]').forEach(d=>{ try{ d.close(); }catch(e){} });
      document.querySelectorAll('[aria-modal="true"]').forEach(el=>el.removeAttribute('aria-modal'));
    } catch(e){}
  }

  // ‚Äî‚Äî‚Äî 2) Overlays markeren (position agnostisch)
  function markOverlays(){
    try{
      const vw = Math.max(1, innerWidth||1), vh = Math.max(1, innerHeight||1), areaV = vw*vh;
      const all = document.body ? document.body.getElementsByTagName('*') : [];
      const limit = Math.min(all.length, 5000);
      for (let i=0;i<limit;i++){
        const el = all[i]; if (!el) break;
        if (el===document.body || el===document.documentElement) continue;
        const cs = getComputedStyle(el);
        if (!cs) continue;
        if (cs.visibility==='hidden' || cs.display==='none') continue;
        const r = el.getBoundingClientRect?.(); if (!r || r.width<=0 || r.height<=0) continue;
        const zi = parseInt(cs.zIndex||'0')||0;
        const area = r.width*r.height, ratio = area/areaV;
        const looksLikeOverlay =
          ratio > 0.75 ||
          ((r.top<=2 && r.left<=2 && r.width>=vw*0.98 && r.height>=vh*0.90) && zi>=5) ||
          /(backdrop|overlay|modal|scrim|blocker)/i.test(el.className||'') ||
          (el.tagName==='IFRAME' && ratio>0.50);
        if (looksLikeOverlay){
          el.classList.add('kgb-overlay');
          if (el.tagName==='IFRAME'){ el.style.pointerEvents='none'; el.style.visibility='hidden'; }
        }
      }
    }catch(e){}
  }

  // ‚Äî‚Äî‚Äî 3) Tijdelijk event-unblocker (5s) voor input-events
  (function eventUnblocker(){
    const TYPES = new Set(['click','pointerdown','pointerup','touchstart','touchend','mousedown','mouseup','contextmenu']);
    const oStop = Event.prototype.stopPropagation;
    const oStopI = Event.prototype.stopImmediatePropagation;
    const oPrev = Event.prototype.preventDefault;
    const start = Date.now();
    function within(){ return (Date.now()-start) < 5000; }

    function guardWrap(orig){
      return function(...args){
        if (within() && TYPES.has(this.type)) { /* laat door */ return; }
        return orig.apply(this, args);
      };
    }
    try {
      Event.prototype.stopPropagation = guardWrap(oStop);
      Event.prototype.stopImmediatePropagation = guardWrap(oStopI);
      Event.prototype.preventDefault = guardWrap(oPrev);
      setTimeout(()=>{ // restore
        Event.prototype.stopPropagation = oStop;
        Event.prototype.stopImmediatePropagation = oStopI;
        Event.prototype.preventDefault = oPrev;
      }, 5200);
    } catch(e){}
  })();

  // ‚Äî‚Äî‚Äî 4) Click proxy: pel overlays weg en redispatch naar onderliggende target
  function peelTargetAt(x,y){
    const undo = [];
    function tempHide(el){
      const prev = { el, pe: el.style.pointerEvents, vis: el.style.visibility, disp: el.style.display };
      el.style.pointerEvents = 'none'; el.style.visibility = 'hidden'; el.style.display = 'contents';
      undo.push(()=>{ el.style.pointerEvents = prev.pe; el.style.visibility = prev.vis; el.style.display = prev.disp; });
    }
    try{
      const stack = document.elementsFromPoint ? document.elementsFromPoint(x,y) : [];
      for (const el of stack){
        if (!el || el===document.documentElement || el===document.body) continue;
        const isOverlay = el.classList.contains('kgb-overlay') ||
                          /(backdrop|overlay|modal|scrim|blocker)/i.test(el.className||'');
        if (isOverlay) tempHide(el);
      }
      let target = document.elementFromPoint(x,y);
      undo.forEach(fn=>fn());
      return target && target !== document.documentElement && target !== document.body ? target : null;
    }catch(e){ undo.forEach(fn=>fn()); return null; }
  }
  function redispatchLike(type, srcEvt, toEl){
    try{
      const ev = new srcEvt.constructor(type, srcEvt);
      toEl.dispatchEvent(ev);
      if (type==='click' && typeof toEl.click==='function') { toEl.click(); }
    }catch(e){}
  }
  function onCapture(e){
    const x = e.clientX ?? (e.touches && e.touches[0] && e.touches[0].clientX) ?? 0;
    const y = e.clientY ?? (e.touches and e.touches[0] and e.touches[0].clientY) ?? 0;
    const under = peelTargetAt(x,y);
    if (!under || under===e.target) return; // niets te doen
    try{
      e.stopImmediatePropagation();
      e.preventDefault();
    }catch(_){}
    // redispatch relevante events naar onderliggende
    const types = e.type === 'pointerup' ? ['pointerdown','pointerup','click'] :
                  e.type === 'mouseup'    ? ['mousedown','mouseup','click'] :
                  e.type === 'touchend'   ? ['touchstart','touchend','click'] : ['click'];
    for (const t of types) redispatchLike(t, e, under);
  }

  // ‚Äî‚Äî‚Äî 5) Schedules & observers
  function runAll(){ unfreeze(); markOverlays(); }
  function schedule(){
    runAll();
    setTimeout(runAll, 100);
    setTimeout(runAll, 500);
    setTimeout(runAll, 1500);
  }
  window.addEventListener('load', schedule, {once:true});
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) schedule(); });
  window.addEventListener('resize', ()=> schedule(), {passive:true});

  try {
    const mo = new MutationObserver(()=> runAll());
    mo.observe(document.documentElement||document.body, {subtree:true, childList:true, attributes:true});
  } catch(e){}

  // capture earliest
  window.addEventListener('click', onCapture, true);
  window.addEventListener('pointerup', onCapture, true);
  window.addEventListener('mouseup', onCapture, true);
  window.addEventListener('touchend', onCapture, true);

  // Debug helper
  window.KGB_FIX_TOGGLE = function(){
    const p = (e)=>{ const x=e.clientX, y=e.clientY; console.log('KGB v3 stack @',x,y, document.elementsFromPoint(x,y)); };
    const on = !window.__kgb_dbg; window.__kgb_dbg = on;
    if (on) { window.addEventListener('click', p); console.log('KGB v3 debug ON'); }
    else { window.removeEventListener('click', p); console.log('KGB v3 debug OFF'); }
  };
})();
</script>

</body>
</html>
