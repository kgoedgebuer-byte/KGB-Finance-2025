<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KGB Finance 2025 ‚Äî Budget</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#7c9cf5">
  <link rel="icon" href="icons/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="app.js"></script>
  <link <link rel="apple-touch-icon" sizes="180x180" href="../icons/kgb-budget-180.png">
  <link rel="stylesheet" href="../common/sync_embed.css">
  <link rel="stylesheet" href="../common/ui_fix.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
<header class="bar">
  <h1>üí∞ KGB Finance 2025 ‚Äî Budget</h1>
  <nav class="tabs">
    <button data-tab="dashboard" class="tab active">Dashboard</button>
    <button data-tab="budget" class="tab">Budget</button>
    <button data-tab="theme" class="tab">Thema</button>
    <button data-tab="io" class="tab">Export / Import</button>
  </nav>
</header>

<main>
  <section id="dashboard" class="panel active">
    <div class="cards">
      <div class="card"><div class="k">Inkomen</div><div class="v" id="totIncome">0,00</div></div>
      <div class="card"><div class="k">Uitgave</div><div class="v" id="totExpense">0,00</div></div>
      <div class="card"><div class="k">Saldo</div><div class="v ok" id="totSaldo">0,00</div></div>
    </div>

    <div class="chartBar">
      <div class="left">
        <strong>Grafiek:</strong>
        <label><input type="radio" name="ctype" value="line" checked> Lijn</label>
        <label><input type="radio" name="ctype" value="bar"> Balk</label>
        <label><input type="radio" name="ctype" value="pie"> Cirkel</label>
      </div>
      <div class="right">
        <button id="btnDemo">Demo-data</button>
        <button id="btnClear">Refresh</button>
      </div>
    </div>
    <canvas id="saldoChart" height="160"></canvas>
  </section>

  <section id="budget" class="panel">
    <h2>üìã Budget</h2>
    <form id="addBudget" class="addForm">
      <input id="b_date" type="date" required />
      <input id="b_cat" type="text" placeholder="Categorie" required />
      <input id="b_desc" type="text" placeholder="Omschrijving" />
      <input id="b_inc" type="number" step="0.01" inputmode="decimal" placeholder="Inkomen">
      <input id="b_exp" type="number" step="0.01" inputmode="decimal" placeholder="Uitgave">
      <button type="submit">‚ûï Toevoegen</button>
    </form>

    <div class="tableWrap">
      <table id="tblBudget" class="grid">
        <thead>
          <tr><th>Datum</th><th>Categorie</th><th>Omschrijving</th><th>Inkomen</th><th>Uitgave</th><th>Saldo (loopt)</th><th>Acties</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="theme" class="panel">
    <h2>üé® Thema</h2>
    <div class="themeBox">
      <label>Onderdeel:
        <select id="themeTarget">
          <option value="bg">Achtergrond</option>
          <option value="card">Kaarten/Tabel</option>
          <option value="acc">Accent/Knoppen</option>
          <option value="grid">Rasterlijnen</option>
          <option value="txt">Tekst</option>
        </select>
      </label>
      <div id="swatches" class="swatches"></div>
      <div class="sliders">
        <label>Intensiteit <input id="intensity" type="range" min="50" max="150" value="100"></label>
        <label>Raster <input id="gridIntensity" type="range" min="50" max="150" value="100"></label>
      </div>
      <div class="themeBtns">
        <button id="themeReset">Reset</button>
        <button id="themeSave">Opslaan</button>
      </div>
    </div>
  </section>

  <section id="io" class="panel">
    <h2>‚¨áÔ∏è Export / ‚¨ÜÔ∏è Import</h2>
    <div class="io-actions">
      <button id="btnExport">Export JSON</button>
      <label class="fileLabel">Import JSON <input id="fileImport" type="file" accept="application/json"></label>
      <button id="btnReset" class="danger">Reset (alles wissen)</button>
    </div>
    <p class="muted">PWA ‚Äì werkt offline na 1√ó laden.</p>
  </section>
</main>

<footer><small>¬© KGB Finance 2025</small></footer>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => void 0 && navigator.serviceWorker.register('./service-worker.js'));
}
</script>
<script>if('serviceWorker' in navigator){void 0 && navigator.serviceWorker.register('./sw.js',{scope:'./'});}</script>
  <script src="../common/sync_embed.js" defer></script>
  <script src="../common/kgb_year_dropdown.js" defer></script>
  <script src="../common/drive_autopull.js"></script>
  <script src="../common/ui_fix.js"></script>
  <script defer src="../common/pwa_hotfix.js"></script>
  <script defer src="../common/layout_fix.js"></script>
  <script defer src="../common/ui_rescue.js"></script>

<style id="kgb-fix-style">
  /* Scroll altijd toestaan (sommige apps zetten body op hidden) */
  html, body { overflow: auto !important; }
  /* Zet jaar-UI nooit fullscreen/fixed */
  .year-fixed, .year-floating, #year-box, [data-year], .year, .kgb-year {
    position: static !important; inset:auto !important; width:auto !important; height:auto !important;
    pointer-events:auto !important; z-index:auto !important; display:inline-block !important; margin:0 .5rem .5rem 0 !important;
  }
  /* Maak mogelijke overlays onschadelijk */
  .kgb-blocker, [role="dialog"], [aria-modal="true"], .modal, .overlay, .backdrop, .scrim {
    pointer-events:none !important; background:transparent !important;
  }
</style>
<script id="kgb-fix-clicks">
(function(){
  // 1) Service Workers neutraliseren (klik-blok via SW/FS overlays voorkomen)
  if ('serviceWorker' in navigator) {
    try {
      navigator.serviceWorker.getRegistrations()
        .then(rs => Promise.all(rs.map(r => r.unregister())))
        .catch(()=>{});
      // Blokkeer toekomstige registraties
      try {
        var _orig = navigator.serviceWorker.register;
        navigator.serviceWorker.register = function(){
          console.log('KGB: SW-register geblokkeerd');
          return Promise.resolve({unregister:()=>Promise.resolve(true)});
        };
      } catch(e){}
    } catch(e){}
  }
  // Ruim caches op die mogelijk overlay-assets vasthouden
  try {
    if (window.caches && caches.keys) {
      caches.keys().then(ks => Promise.all(ks.map(k => caches.delete(k)))).catch(()=>{});
    }
  } catch(e){}

  // 2) Heuristiek: identificeer een fullscreen overlay rond centrum en ontkoppel clicks
  function killBlocker(){
    try{
      const vw = window.innerWidth, vh = window.innerHeight;
      const stack = (document.elementsFromPoint?.(vw/2, vh/2)) || [];
      let best = null, bestZi = -1;
      for (const el of stack){
        const cs = getComputedStyle(el);
        if (!cs) continue;
        const r = el.getBoundingClientRect?.(); if (!r) continue;
        const zi = parseInt(cs.zIndex||"0")||0;
        if ((cs.position==='fixed' || cs.position==='absolute')
            && r.width > vw*0.6 && r.height > vh*0.6
            && zi >= 10 && el !== document.documentElement && el !== document.body){
          if (zi > bestZi) { best = el; bestZi = zi; }
        }
      }
      if (best){
        best.classList.add('kgb-blocker');
        console.log('KGB: click-blocker uitgeschakeld:', best.tagName, 'z=', bestZi);
      }
    }catch(e){ console.log('KGB fix fout:', e); }
  }

  // 3) Re-try vensters (load, visibility, DOM-mutaties)
  function schedule(){
    setTimeout(killBlocker, 100);
    setTimeout(killBlocker, 600);
    setTimeout(killBlocker, 1500);
    let n = 0; const t = setInterval(()=>{ killBlocker(); if (++n>6) clearInterval(t); }, 500);
  }
  window.addEventListener('load', schedule, { once: true });
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) schedule(); });

  try{
    const mo = new MutationObserver(()=> killBlocker());
    mo.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true});
  }catch(e){}
})();
</script>

</body>
</html>
