<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KGB — Debug harnas v2</title>
<style>
  :root{--g:#1bd97b;--bg:#0b132b}
  body{margin:0;font:14px/1.5 -apple-system,Segoe UI,Arial,sans-serif;background:#eef1f4}
  .bar{position:sticky;top:0;z-index:5;background:var(--bg);color:#e6fff2;padding:8px;border-bottom:1px solid #0e7952;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .bar button{padding:8px 10px;border-radius:10px;border:1px solid var(--g);background:#0f5132;color:#e6fff2;cursor:pointer}
  .bar button.ghost{background:#021a12}
  .bar .sep{opacity:.6;margin:0 4px}
  iframe{width:100%;height:78vh;border:0;background:white}
  #log{background:#111;color:#0f0;margin:0;max-height:20vh;overflow:auto;white-space:pre-wrap;padding:8px;border-top:1px solid #333}
</style>

<div class="bar">
  <button id="spam">Spam-unlock</button>
  <button id="once">Kill cover (midden)</button>
  <span class="sep">|</span>
  <button id="panic">Panic-CSS aan/uit</button>
  <button id="demo" class="ghost">Klik “Demo-data”</button>
  <button id="reset" class="ghost">Hard reset</button>
  <small>Gebruik deze als klikken niet werkt.</small>
</div>
<iframe id="app" src="./"></iframe>
<pre id="log"></pre>

<script>
const I = document.getElementById('app');
const L = document.getElementById('log');
const log = (...a)=>{ L.textContent = '['+new Date().toLocaleTimeString()+'] '+a.join(' ')+'\n'+L.textContent; };

function withFrame(cb){
  const w = I.contentWindow; const d = I.contentDocument || (w && w.document);
  if (!w || !d) { alert('Frame nog niet geladen'); return; }
  return cb(w,d);
}

function inject(w,d){
  if (w.__KGB_H2__) return; w.__KGB_H2__=true;
  w.KGB_panicOn = false;

  w.KGB_panicToggle = ()=>{
    const id='__kgb_panic_css__';
    let el=d.getElementById(id);
    if(el){ el.remove(); w.KGB_panicOn=false; return true; }
    el=d.createElement('style'); el.id=id;
    el.textContent=`
      *,*::before,*::after{pointer-events:auto!important;opacity:1!important;visibility:visible!important}
      html,body,#root,#app,main{pointer-events:auto!important}
      [inert]{pointer-events:auto!important}
      .overlay,.backdrop,.modal,.scrim,.spinner,.loading,.preloader,#overlay,#backdrop,#modal,#spinner,#loading,[data-loading],[data-blocker],dialog[open]{display:none!important;pointer-events:none!important}
      iframe{display:none!important;pointer-events:none!important}
    `;
    d.head.appendChild(el); w.KGB_panicOn=true; return true;
  };

  w.KGB_unlock = function(doc){
    doc = doc || d;
    try{
      doc.querySelectorAll('[inert]').forEach(x=>x.removeAttribute('inert'));
      doc.querySelectorAll('dialog[open]').forEach(x=>{ try{x.close();}catch(_){} });
      doc.querySelectorAll('[aria-modal="true"]').forEach(x=>x.removeAttribute('aria-modal'));
      const host=(doc.getElementById('root')||doc.getElementById('app')||doc.querySelector('main')||doc.body);
      if(host) host.style.pointerEvents='auto';
      const sel='a,button,input,select,textarea,summary,[role="button"],[role="link"],[role="tab"],[onclick],[tabindex]';
      doc.querySelectorAll(sel).forEach(el=>{ try{
        el.disabled=false; el.removeAttribute('disabled');
        const cs=(doc.defaultView||w).getComputedStyle(el); if(cs.pointerEvents==='none') el.style.pointerEvents='auto';
      }catch(_){ }});
      // shadow roots
      doc.querySelectorAll('*').forEach(el=>{ const sh=el.shadowRoot; if(sh) w.KGB_unlock(sh); });
    }catch(_){}
  };

  w.KGB_killCoverOnce = ()=>{
    try{
      const vw=w.innerWidth||1,vh=w.innerHeight||1,A=Math.max(1,vw*vh);
      const list = (w.document.elementsFromPoint? w.document.elementsFromPoint(vw/2,vh/2):[]).filter(Boolean);
      for(const el of list){
        if(!el || el===w.document.documentElement || el===w.document.body) continue;
        const r=el.getBoundingClientRect(); const area=(Math.max(0,r.width)*Math.max(0,r.height))/A;
        const cs=w.getComputedStyle(el); const cls=((el.className||'')+' '+(el.id||'')).toLowerCase();
        const looks = area>=0.80 || /(overlay|backdrop|modal|scrim|spinner|loading|blocker)/.test(cls) ||
                      ((cs.position==='fixed'||cs.position==='absolute') && r.width>=vw*0.98 && r.height>=vh*0.90);
        if(looks){
          el.style.setProperty('display','none','important');
          el.style.setProperty('pointer-events','none','important');
          el.removeAttribute('inert');
          return el.tagName+'#'+(el.id||'')+'.'+(el.className||'');
        }
      }
      return null;
    }catch(e){ return 'err:'+e.message; }
  };

  w.KGB_clickByText = (txt)=>{
    const doc=d;
    let target=null;
    doc.querySelectorAll('button,a').forEach(el=>{
      if(!target && (el.textContent||'').trim().toLowerCase().includes(txt.toLowerCase())) target=el;
    });
    if(!target) return false;
    try{ target.click(); }catch(_){}
    try{ target.dispatchEvent(new w.MouseEvent('click',{bubbles:true,cancelable:true,view:w})); }catch(_){}
    return true;
  };

  w.KGB_reset = async ()=>{
    try{ if('serviceWorker' in w.navigator){ const rs=await w.navigator.serviceWorker.getRegistrations(); await Promise.all(rs.map(r=>r.unregister())); } }catch(_){}
    try{ if(w.caches && w.caches.keys){ const ks=await w.caches.keys(); await Promise.all(ks.map(k=>w.caches.delete(k))); } }catch(_){}
    w.location.reload();
  };
}

let spamTimer=null;

document.getElementById('spam').onclick=()=>withFrame((w,d)=>{
  inject(w,d);
  if(spamTimer){ clearInterval(spamTimer); spamTimer=null; log('Spam-unlock: uit'); return; }
  spamTimer=setInterval(()=>{ w.KGB_unlock(d); const hit=w.KGB_killCoverOnce(); if(hit) log('Kill cover:',hit); },300);
  log('Spam-unlock: aan (elke 300ms)');
});

document.getElementById('once').onclick=()=>withFrame((w,d)=>{
  inject(w,d); const hit=w.KGB_killCoverOnce(); log('Kill cover (1x):', hit||'niets gevonden');
});

document.getElementById('panic').onclick=()=>withFrame((w,d)=>{
  inject(w,d); w.KGB_panicToggle(); log('Panic-CSS:', w.KGB_panicOn?'AAN':'UIT');
});

document.getElementById('demo').onclick=()=>withFrame((w,d)=>{
  inject(w,d); const ok=w.KGB_clickByText('demo-data')||w.KGB_clickByText('demo data')||w.KGB_clickByText('demo'); 
  log(ok?'Demo-klik: OK':'Demo-klik: knop niet gevonden');
});

document.getElementById('reset').onclick=()=>withFrame((w,d)=>{
  inject(w,d); w.KGB_reset(); log('Hard reset uitgevoerd…');
});

I.addEventListener('load', ()=>{ log('Frame geladen:', I.src); withFrame((w,d)=>inject(w,d)); });
</script>
